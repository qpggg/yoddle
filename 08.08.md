## Миграция локальной разработки на Docker (08.08)

Документ описывает переход проекта на Docker для локальной разработки, что мы сделали сегодня. Ниже — финальная рабочая схема, команды запуска и примечания по нюансам.

### Цель
- Единый, быстрый старт локального бэкенда без ручной настройки Node/зависимостей на машине
- Горячая перезагрузка через `nodemon`
- Стабильная прокладка к внешней БД (Supabase) либо опциональной локальной БД

### Что уже сделано
- Создан и используется `docker-compose.yml` c сервисом `app` (Node 20)
- Горячая перезагрузка бэкенда: `npm run dev:server` (nodemon)
- Прокси фронтенда (Vite) на бэкенд: 5173 → 3001 (см. `vite.config.ts`)
- Исправлены несовместимости и ошибки:
  - SPA fallback для Express 5 отключен в dev (ошибка path-to-regexp устранена)
  - Feedback API приведён к схеме: `feedback.user_id` — текст, поэтому везде касты `e.id::text = f.user_id`, вставка с `::text`, `::int`
  - Новости: единый эндпоинт `GET /api/news/modal-data`; фронт обновлён на него

### Текущая схема портов
- Бэкенд (Express): `http://localhost:3001`
- Фронтенд (Vite dev server): `http://localhost:5173` (запускается на хосте)

### Переменные окружения
- `PG_CONNECTION_STRING` — строка подключения к PostgreSQL (сейчас Supabase)
  - Установлена в `docker-compose.yml`
  - Также подхватывается `.env` через `dotenv` (для non-docker сценариев)

### Команды (Windows PowerShell)
- Запуск бэкенда в Docker:
  - `docker compose up -d`
- Логи бэкенда:
  - `docker compose logs --tail=100 app`
- Перезапуск:
  - `docker compose restart app`
- Шелл внутри контейнера:
  - `docker compose exec app sh`
- Остановка и удаление контейнера:
  - `docker compose down`

Важно: в PowerShell не используйте `&&` в одной строке.

### Запуск фронтенда (на хосте)
1) Установка зависимостей: `npm install`
2) Старт dev-сервера: `npm run dev`
3) Открыть: `http://localhost:5173` (запросы `/api/*` уходят на `http://localhost:3001`)

### Файл `docker-compose.yml` (ключевые моменты)
- Образ: `node:20`
- Том: `.:/app` + отдельный анонимный том на `/app/node_modules`
- Команда старта: `npm ci || npm install && npm run dev:server`
- Порты: `3001:3001`
- Env: `NODE_ENV=development`, `PORT=3001`, `PG_CONNECTION_STRING=...`

### Файл `Dockerfile`
- Базируется на `node:18` (сейчас не используется compose-ом для сборки dev-контейнера)
- Оставлен для будущих сборок production-образа; для dev достаточно compose-сервиса `app`

### Проверка работоспособности
- Логин: `POST /api/login`
- Новости (модалка): `GET /api/news/modal-data?limit=10`
- Отзывы:
  - Недавние: `GET /api/feedback?action=recent`
  - Проверка, оставлял ли отзыв юзер: `GET /api/feedback?action=check-user&user_id=...`
  - Отправка: `POST /api/feedback` c JSON `{ user_id: string, rating: 1..5, comment: string }`

### Нюансы и решения
- Express 5 + path-to-regexp: строковый `'*'` больше нельзя использовать. Для dev мы убрали SPA fallback — роутинг обрабатывает Vite. Для production сборки статику (`dist`) отдаёт сервер, а SPA fallback можно добавить аккуратным midlleware (после всех API), но только для собранного фронтенда.
- Типы в БД:
  - `feedback.user_id` — `text`, а `enter.id` — `integer`. Используем сравнение `e.id::text = f.user_id` и явные касты в инсертах/селектах.
- Новости: используем объединённый запрос c `JOIN news_categories` и нормализуем даты в ISO на сервере.

### Частые ошибки и как чинить
- 500 на `/api/feedback?action=recent`:
  - Причина: сравнение `text` и `integer`. Исправление: `LEFT JOIN enter e ON e.id::text = f.user_id` и касты `$1::text`.
- Ошибка `Missing parameter name at ... path-to-regexp` при старте:
  - Причина: Express 5 + глобальный шаблон. Решение: убрать строковый `*` fallback в dev.
- Дубликат `user_progress`: `duplicate key value violates ... user_progress_user_id_key`:
  - Причина: повторная вставка/триггеры. Не критично для dev, но стоит избегать повторного создания записей вручную.

### Опционально (как расширить)
1) Фронтенд в Docker (hot reload на Windows):
```
  web:
    image: node:20
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - CHOKIDAR_USEPOLLING=1
    volumes:
      - .:/app
      - /app/node_modules
    command: sh -c "npm ci --no-audit --no-fund || npm install --no-audit --no-fund && npm run dev"
```
2) Локальная PostgreSQL в Docker (вместо Supabase):
```
  db:
    image: postgres:16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

volumes:
  pgdata:
```
И поменять в `app.environment`:
```
PG_CONNECTION_STRING=postgres://postgres:postgres@db:5432/postgres
```
Далее — выполнить нужные SQL-скрипты миграций из корня (`*.sql`).

### Итог
- Локальная разработка теперь запускается одной командой `docker compose up -d` + `npm run dev` для фронта
- Исправлены критичные несовместимости схемы/роутов
- Документ служит единой инструкцией “как поднять” и “как расширить” локальное окружение











