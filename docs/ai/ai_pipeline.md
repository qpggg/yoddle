### Цель
Сформировать замкнутый AI‑контур: от корпоративных данных к измеримой «карте вовлечённости» и умным рекомендациям, интегрированным с кошельком Y‑coins.

### Поток (по слайду)
- **Корпоративные данные**: календари, CRM‑логи, опросы, льготы, оргструктура
- → **Карта вовлечённости**: сильные/слабые стороны, настроение, рейтинг, интегральный индекс
- → **Умные рекомендации**: персональные/командные, budget‑aware (учёт баланса и цен)

### Источники
- Календари (busy‑rate, overtime), CRM (нагрузка, win/loss), опросы (sentiment/eNPS), льготы (история покупок), оргструктура (иерархия, команды)

### Фичи и индекс
- Индивидуальные: стресс/настроение/перегрузка (окна 1д/7д/30д), паттерны встреч/коммуникаций
- Командные: дисбаланс, падения настроения по отделам, риски выгорания
- Индекс вовлечённости = w1*sentiment + w2*load_anomaly + w3*usage + … (калибруется по пилотам)

### Модельный стек (MVP → расширение)
- Sentiment/Topics: ru‑bert + правила (токсиность/стресс‑лексика)
- Аномалии: robust z‑score/Prophet на ритмах календаря/CRM
- Рекомендации: Hybrid (rules + content‑based), затем MF/LightFM; budget‑aware слой (баланс/цена)
- Командные инсайты: агрегирование по org, правила «что делать»

### API (скелет)
- `POST /api/ai/ingest` — приём сигналов (batched JSON)
- `GET /api/ai/engagement?user_id=` — карта вовлечённости и индекс
- `GET /api/ai/recommendations?user_id=&limit=` — персональные рекомендации (льготы/активности)
- `GET /api/ai/insights?team_id=` — командные сигналы

### Схема БД (минимум)
- `ai_signals(id, user_id, source, ts, payload jsonb)`
- `ai_features(user_id, ts, engagement_score, stress_score, mood_score, strengths jsonb, weaknesses jsonb)`
- `ai_recommendations(user_id, benefit_id, score, reason, created_at)`
- `ai_team_insights(team_id, ts, insight_type, payload jsonb)`

### Интеграция с кошельком
- Отдавать только достижимые рекомендации: `price_coins ≤ balance`
- Логировать принятие рекомендации → улучшение скоринга (explore/exploit)
- Учитывать историю транзакций coin_transactions в фичах «usage»

### Провайдеры/адаптер
- AI Provider: YandexGPT / GigaChat / локальная LLM — через адаптер (переключение провайдера)
- Fallback: недоступен провайдер → rule‑based рекомендации
- Фича‑флаги: включение AI по компаниям/юзерам, безопасный rollout

### Безопасность
- Псевдонимизация user_id, минимизация полей
- Аудит‑лог всех вызовов `/api/ai/*`
- Rate‑limits и таймауты; ретраи/идемпотентность ingest

### Метрики
- CTR/accept rate рекомендаций, Δ вовлечённости/настроения, использование льгот; eNPS/NPS

### Поэтапно (2 недели MVP)
- Дни 1–2: схемы БД + `/api/ai/ingest` + ETL
- Дни 3–5: расчёт фич/индекса `/api/ai/engagement`
- Дни 6–8: рекомендации + budget‑aware слой `/api/ai/recommendations`, склейка с кошельком
- Дни 9–10: командные инсайты `/api/ai/insights` + UI‑виджеты
- Дни 11–12: метрики/алерты/флаги, правила фолбэка провайдеров
- Дни 13–14: документация, демонстрация пилотам
