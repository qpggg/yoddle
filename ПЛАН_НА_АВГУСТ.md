## План на август: Yoddle (кошелёк Yoddle Coins, AI‑модуль, кабинет руководителя, безопасность и масштабирование)

Дата: 08.08

### Цели месяца
- Запустить кошелёк Yoddle Coins и «кафетерий льгот» под новую модель (SaaS 150–450 ₽ + Yoddle Coins).
- Включить AI‑модуль рекомендаций и помощника для пользователей.
- Добавить кабинет руководителя с контролем бюджета/льгот и аналитикой.
- Довести продукт до «идеального» состояния для демо клиентам.
- Подготовить безопасность/конфиденциальность под 152‑ФЗ и масштабирование до 20 000 пользователей.

---

### Дорожная карта (недели и вехи)

| Неделя | Вехи и критерии готовности |
|---|---|
| 08–11 авг | Архитектура Yoddle Coins, финализация схем БД, эндпоинты, UI‑макеты. PRD по AI‑модулю. RBAC/ролевая модель. |
| 12–18 авг | Кошелёк + кафетерий (MVP): баланс, транзакции, покупка льгот, админ‑начисления, уведомления. Бэкенд/фронт + тесты. |
| 19–24 авг | AI‑модуль (альфа): рекомендации льгот, подсказки в кабинете, безопасная интеграция провайдера. Кабинет руководителя (MVP). |
| 25–31 авг | Security & Scalability: аудит ролей, логирование, бэкапы, индексы, нагрузочные тесты (до 20 000). Полировка UX и релиз. |

Критерий успешности месяца: демо для 2–3 пилотных компаний; кошелёк + AI работают на проде; безопасность/масштабирование подтверждены чек‑листом.

---

### 1) Yoddle Coins и «кафетерий льгот»

Функционал:
- Баланс пользователя, история транзакций, ежемесячные начисления (allowance), покупки льгот за коины, опционально возвраты.
- Админ/HR: пополнение баланса, задания месячных лимитов по отделам/компаниям, отчёты по расходам/популярности.
- Уведомления: списания/начисления, достижения (XP), статус заявок.

Схема БД (дополнения к текущей):
- `benefits`: добавить `price_coins numeric NOT NULL DEFAULT 0`.
- Уже есть:
  - `user_balance(user_id unique, balance, total_earned, total_spent)` — актуализировать триггеры/обновления.
  - `coin_transactions(id, user_id, transaction_type, amount, balance_before, balance_after, description, reference_id, processed_by, created_at)`.

API (черновик):
- `GET /api/wallet` → `{ balance, totalEarned, totalSpent }`.
- `GET /api/wallet/transactions?limit=&offset=` → список операций (пагинация).
- `POST /api/wallet/purchase` → `{ user_id, benefit_id }` (проверка лимита, списание, запись транзакции, уведомление).
- `POST /api/wallet/allowance/run` (CRON/задача) → массовое начисление по политике компании.
- `POST /api/wallet/credit` (админ) → ручное начисление/списание.

Бизнес‑правила:
- Единицы — коины (1 coin == 1 ₽ по умолчанию, на уровне конфигурации компании допускается коэффициент).
- Покупка льготы списывает `price_coins`, создает транзакцию `benefit_purchase`.
- Месячная выдача — `monthly_allowance` с записью в `coin_transactions` и апдейтом `user_balance`.

UI/UX:
- В Dashboard: карточка «Кошелёк», быстрый просмотр баланса, CTA «Кафетерий».
- В «Мои льготы»: фильтр по цене/категориям, кнопка «Купить за X Y‑coins», подтверждение, тосты.

Тесты:
- Юниты (правила списаний) + интеграционные (покупка льготы, повторная покупка, откат при ошибке).

---

### 2) AI‑модуль (рекомендации и помощник)

Ценности:
- Подбор льгот по поведению и профилю (используем `benefit_recommendations`, `activity_log`, `user_progress`).
- Встроенный помощник: ответы по продукту/политикам компании, подсказки по использованию льгот.

Архитектура:
- Сервис `AI Provider` (адаптер): `YandexGPT / GigaChat / локальная LLM` (выбор по доступности). Падение провайдера → graceful fallback на rule‑based рекомендации.
- Эндпоинты:
  - `POST /api/ai/recommendations` → список льгот с приоритетами (кеш 1–6 ч.).
  - `POST /api/ai/assistant` → ответы на вопросы (анонимизация PII перед отправкой внешнему провайдеру).

Безопасность AI:
- Политика передачи данных провайдеру (минимизация полей, маскирование PII).
- Логи запросов без сырых персональных данных.

MVP‑метрики:
- CTR на рекомендованные льготы, конверсия в покупку, CSAT по ответам ассистента.

---

### 3) Кабинет руководителя (HR/менеджер)

Роли и доступы (RBAC):
- `admin` — глобальные настройки, бюджеты, каталоги льгот.
- `manager` — управление командой/бюджетом, начисления, утверждения заявок.
- `user` — стандартный пользователь.

Функции MVP:
- Дашборд компании: активность, траты Y‑coins, популярные льготы, вовлеченность.
- Начисления по командам/сотрудникам, лимиты и перенастройки планов.
- Управление новостями/уведомлениями (у нас уже есть `/api/news`, `/api/notifications`).

API/Фронт:
- `GET /api/admin/overview`, `GET /api/admin/wallet`, `POST /api/admin/allowance/bulk`, `GET /api/admin/reports`.
- Страницы: `Admin Dashboard`, `Budgets & Allowance`, `Benefits Catalog`, `Reports`.

---

### 4) Security & Privacy (152‑ФЗ) и подготовка к аудитам

Контроль доступа и журналы:
- Единая RBAC (middleware), запреты на горизонтальный доступ.
- `audit_log` для критичных операций (начисления, списания, изменение профиля).

Данные и хранение:
- Шифрование в транзите (HTTPS). Хранение в российской юрисдикции для прод (Yandex Cloud/VK Cloud), резервные копии.
- Маскирование PII в логах, политика хранения/удаления (ретеншн 90 дней логи, 30 дней бэкапы).

Процессы:
- Политика инцидентов (SLA оповещения), чек‑лист разработчика (секреты в .env, ротация ключей), статический анализ.
- Rate‑limit и защита от брутфорса на аутентификации.

Compliance артефакты:
- Политика конфиденциальности, Условия, DPA, журнал обработки ПДн, перечень ИСПДн/обработчиков.

---

### 5) Масштабирование до 20 000 пользователей

БД и запросы:
- Индексы: `activity_log(user_id, created_at)`, `coin_transactions(user_id, created_at)`, `benefit_recommendations(user_id, priority)`.
- PgBouncer/Pooling, ограничение `max` пула в приложении, таймауты.
- Миграции: добавить `price_coins` и необходимые внешние ключи/ON CONFLICT стратегии.

Производительность:
- Кеширование (in‑memory на запросы рекомендаций/справочники на 5–15 мин), ETag/Cache‑Control на статику.
- Асинхронные очереди (email/уведомления) — простейший Redis‑backed queue.

Инфраструктура:
- Наблюдаемость: Prometheus/Grafana или облачные метрики, алерты по p95/p99, ошибкам 5xx, времени ответа БД.
- Горизонтальное масштабирование фронта, бэкенда, CDN для статики; ночные джобы вплоть до шардирования.

Нагрузочное тестирование:
- K6/JMeter сценарии: логин, просмотр дашборда, покупка льготы, массовое начисление (CRON). Цель: p95 < 300 мс, ошибка < 1%.

---

### 6) «Идеализация» продукта (polish)
- Единая система ошибок и тостов; пустые состояния; скелетоны загрузки.
- Мобильные сценарии (кошелёк/покупка льгот/новости/уведомления).
- Онбординг (тур/подсказки) и «Что нового» (из `/api/news`).

---

### Чек‑лист приемки по блокам
- Кошелёк: корректные списания/начисления, идемпотентность, прозрачная история, отчёт по отделу.
- Кафетерий: покупка льготы, ограничения по плану, уведомления, возвраты (если допустимо).
- AI: рекомендации выдаются, ассистент отвечает, телеметрия собирается, PII не утекает.
- Кабинет руководителя: видимость только своей компании/команды, отчёты, массовые начисления.
- Security: RBAC, аудит‑лог, логирование без PII, бэкапы, политика восстановления.
- Scale: индексы, пулы, кеши, p95 < 300 мс на ключевых маршрутах при 20k пользователей (профиль, дашборд, кошелёк).

---

### Риски и план B
- Провайдер AI недоступен → переключение на другой/локальный, rule‑based fallback.
- Ограничения по внешней БД → локальный PostgreSQL в облаке, pgBouncer, снижение частоты тяжёлых агрегаций.
- Сжатые сроки → фича‑флаги и итеративный rollout (кошелёк → AI → кабинет руководителя).







